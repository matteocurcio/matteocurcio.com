---
import { getCollection } from "astro:content";
import BaseLayout from "../layouts/BaseLayout.astro";
import { LEGACY_WORKS, WORK_CATEGORIES, type WorkCategory } from "../data/legacyPortfolio";
import { NON_COMPARE_THUMBNAILS } from "../data/nonCompareProjectOverrides";
import wpProjectContent from "../data/wpProjectContent.json";

type WpContentMap = Record<string, { images?: string[] }>;
const wpContent = wpProjectContent as WpContentMap;

const projects = await getCollection("projects");
const projectMap = new Map(projects.map((project) => [project.slug, project]));
const CATEGORY_KEY_BY_LABEL: Record<WorkCategory, "colour" | "motion" | "immersive" | "video" | "photo"> = {
  "COLOUR": "colour",
  "MOTION": "motion",
  "IMMERSIVE": "immersive",
  "VIDEO": "video",
  "PHOTO": "photo"
};

const GENERIC_THUMBNAIL = "/migrated/wp-content/uploads/borouge_day2_1000.jpg";


const WORK_THUMB_OVERRIDES: Record<string, string> = {
  "expo-2020-iptm18": "/migrated/wp-content/uploads/Seamless-Participant-Journey-03-scaled.jpg",
  "expo-2020-iptm19": "/migrated/wp-content/uploads/EXPO2020-IPM19-4-Venues-Overview.020.jpeg",
  "expo-2020-global-media-briefing": "/migrated/wp-content/uploads/03-Expo-Site-overview.044-scaled.jpeg",
  "dubai-business-events": "/migrated/wp-content/uploads/DTCM-BEP2020-20200319.002.jpg",
  "dubai-master-business-presentation": "/migrated/wp-content/uploads/DTCM-MBP2019-chapter-1-20191029.023.jpg",
  "gitex-vr": "/migrated/wp-content/uploads/IMG_5887.jpg",
  "renault-zoe": "/migrated/wp-content/uploads/Renault-Keynote-20171028.018.jpeg",
  "welcome-to-sharjah": "/migrated/wp-content/uploads/IMG_1671.jpg",
  "mrajeeb-al-fhood": "/migrated/wp-content/uploads/untitled-1-of-103.jpg",
  "dms17-cadillac": "/migrated/wp-content/uploads/DMS17_cadillac_1.jpeg",
  "dms17-gmc": "/migrated/wp-content/uploads/20171111-GMC.009.jpeg",
  "patterns": "/migrated/wp-content/uploads/untitled-135-of-145.webp"
};

function isGenericThumb(src?: string) {
  return !src || src === GENERIC_THUMBNAIL;
}

const works = LEGACY_WORKS.map((item) => {
  const project = projectMap.get(item.slug);
  const wpImages = wpContent[item.slug]?.images || [];
  const bestWpImage = wpImages.find((src) => !isGenericThumb(src));
  const nonCompareThumb = NON_COMPARE_THUMBNAILS[item.slug];
  const overrideThumb = WORK_THUMB_OVERRIDES[item.slug];

  const resolvedImage = [
    !isGenericThumb(nonCompareThumb) ? nonCompareThumb : undefined,
    overrideThumb,
    !isGenericThumb(item.image) ? item.image : undefined,
    bestWpImage,
    !isGenericThumb(project?.data.cover) ? project?.data.cover : undefined,
    item.image,
    project?.data.cover,
    wpImages[0]
  ].find(Boolean) as string | undefined;

  return {
    ...item,
    categoryKey: CATEGORY_KEY_BY_LABEL[item.category],
    image: resolvedImage || "",
    href: `/projects/${item.slug}/`
  };
}).filter((item) => Boolean(item.image));

const filterOrder: Array<{ key: "all" | "colour" | "motion" | "immersive" | "video" | "photo"; label: "ALL" | WorkCategory }> = [
  { key: "all", label: "ALL" },
  ...WORK_CATEGORIES.map((category) => ({ key: CATEGORY_KEY_BY_LABEL[category], label: category }))
];
---

<BaseLayout title="Projects | Matteo Curcio" description="Selected projects." path="/works">
  <section class="works-category-bar" aria-label="Work categories">
    {filterOrder.map((filter) => (
      <button
        type="button"
        class={`works-category-link ${filter.key === "all" ? "is-active" : ""}`}
        data-work-filter-key={filter.key}
        aria-pressed={filter.key === "all" ? "true" : "false"}
      >
        {filter.label}
      </button>
    ))}
  </section>

  <section class="works-grid" aria-label="Selected works" data-work-grid>
    {works.map((item) => (
      <a class="works-tile" href={item.href} aria-label={item.title} data-work-category-key={item.categoryKey}>
        <div class="works-media" data-hover-preview={item.video ? "true" : undefined}>
          <img src={item.image} alt={item.title} loading="lazy" />
          {item.video ? (
            <video class="works-preview" src={item.video} muted loop playsinline preload="none" aria-hidden="true" />
          ) : null}
        </div>
      </a>
    ))}
  </section>
</BaseLayout>

<script is:inline>
  document.addEventListener("DOMContentLoaded", () => {
    const filterButtons = Array.from(document.querySelectorAll("[data-work-filter-key]"));
    const grid = document.querySelector("[data-work-grid]");
    if (!grid) return;

    const tiles = Array.from(grid.querySelectorAll("[data-work-category-key]"));

    const applyFilter = (key) => {
      filterButtons.forEach((button) => {
        const isActive = button.getAttribute("data-work-filter-key") === key;
        button.classList.toggle("is-active", isActive);
        button.setAttribute("aria-pressed", isActive ? "true" : "false");
      });

      const visibleTiles = [];
      const hiddenTiles = [];

      tiles.forEach((tile) => {
        const tileCategory = tile.getAttribute("data-work-category-key");
        const visible = key === "all" || tileCategory === key;
        if (visible) {
          visibleTiles.push(tile);
        } else {
          hiddenTiles.push(tile);
        }
      });

      // Force real reflow order so filtered items occupy 1..N positions.
      visibleTiles.forEach((tile) => {
        tile.hidden = false;
        tile.classList.remove("is-hidden");
        grid.appendChild(tile);
      });

      hiddenTiles.forEach((tile) => {
        grid.appendChild(tile);
        tile.classList.add("is-hidden");
        tile.hidden = true;
      });

      visibleTiles.forEach((tile) => {
        tile.animate(
          [
            { opacity: 0 },
            { opacity: 1 }
          ],
          {
            duration: 280,
            easing: "ease-out"
          }
        );
      });
    };

    filterButtons.forEach((button) => {
      button.addEventListener("click", () => {
        const key = button.getAttribute("data-work-filter-key") || "all";
        applyFilter(key);
      });
    });

    applyFilter("all");
  });
</script>
