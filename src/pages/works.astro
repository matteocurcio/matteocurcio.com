---
import { getCollection } from "astro:content";
import BaseLayout from "../layouts/BaseLayout.astro";
import { LEGACY_WORKS, WORK_CATEGORIES, type WorkCategory } from "../data/legacyPortfolio";
import { NON_COMPARE_THUMBNAILS } from "../data/nonCompareProjectOverrides";
import wpProjectContent from "../data/wpProjectContent.json";

type WpContentMap = Record<string, { images?: string[] }>;
const wpContent = wpProjectContent as WpContentMap;

const projects = await getCollection("projects");
const projectMap = new Map(projects.map((project) => [project.slug, project]));
const CATEGORY_KEY_BY_LABEL: Record<WorkCategory, "colour" | "motion" | "immersive" | "video" | "photo"> = {
  "COLOUR": "colour",
  "MOTION": "motion",
  "IMMERSIVE": "immersive",
  "VIDEO": "video",
  "PHOTO": "photo"
};

const works = LEGACY_WORKS.map((item) => {
  const project = projectMap.get(item.slug);
  const fallbackImage = NON_COMPARE_THUMBNAILS[item.slug] || wpContent[item.slug]?.images?.[0] || project?.data.cover || "";
  return {
    ...item,
    categoryKey: CATEGORY_KEY_BY_LABEL[item.category],
    image: item.image || fallbackImage,
    href: `/projects/${item.slug}/`
  };
}).filter((item) => Boolean(item.image));

const filterOrder: Array<{ key: "all" | "colour" | "motion" | "immersive" | "video" | "photo"; label: "ALL" | WorkCategory }> = [
  { key: "all", label: "ALL" },
  ...WORK_CATEGORIES.map((category) => ({ key: CATEGORY_KEY_BY_LABEL[category], label: category }))
];
---

<BaseLayout title="Projects | Matteo Curcio" description="Selected projects." path="/works">
  <section class="works-category-bar" aria-label="Work categories">
    {filterOrder.map((filter) => (
      <button
        type="button"
        class={`works-category-link ${filter.key === "all" ? "is-active" : ""}`}
        data-work-filter-key={filter.key}
        aria-pressed={filter.key === "all" ? "true" : "false"}
      >
        {filter.label}
      </button>
    ))}
  </section>

  <section class="works-grid" aria-label="Selected works" data-work-grid>
    {works.map((item) => (
      <a class="works-tile" href={item.href} aria-label={item.title} data-work-category-key={item.categoryKey}>
        <div class="works-media" data-hover-preview={item.video ? "true" : undefined}>
          <img src={item.image} alt={item.title} loading="lazy" />
          {item.video ? (
            <video class="works-preview" src={item.video} muted loop playsinline preload="none" aria-hidden="true" />
          ) : null}
        </div>
      </a>
    ))}
  </section>
</BaseLayout>

<script is:inline>
  document.addEventListener("DOMContentLoaded", () => {
    const filterButtons = Array.from(document.querySelectorAll("[data-work-filter-key]"));
    const grid = document.querySelector("[data-work-grid]");
    if (!grid) return;

    const tiles = Array.from(grid.querySelectorAll("[data-work-category-key]"));

    const applyFilter = (key) => {
      filterButtons.forEach((button) => {
        const isActive = button.getAttribute("data-work-filter-key") === key;
        button.classList.toggle("is-active", isActive);
        button.setAttribute("aria-pressed", isActive ? "true" : "false");
      });

      const visibleTiles = [];
      const hiddenTiles = [];

      tiles.forEach((tile) => {
        const tileCategory = tile.getAttribute("data-work-category-key");
        const visible = key === "all" || tileCategory === key;
        if (visible) {
          visibleTiles.push(tile);
        } else {
          hiddenTiles.push(tile);
        }
      });

      // Force real reflow order so filtered items occupy 1..N positions.
      visibleTiles.forEach((tile) => {
        tile.hidden = false;
        tile.classList.remove("is-hidden");
        grid.appendChild(tile);
      });

      hiddenTiles.forEach((tile) => {
        grid.appendChild(tile);
        tile.classList.add("is-hidden");
        tile.hidden = true;
      });

      visibleTiles.forEach((tile) => {
        tile.animate(
          [
            { opacity: 0 },
            { opacity: 1 }
          ],
          {
            duration: 280,
            easing: "ease-out"
          }
        );
      });
    };

    filterButtons.forEach((button) => {
      button.addEventListener("click", () => {
        const key = button.getAttribute("data-work-filter-key") || "all";
        applyFilter(key);
      });
    });

    applyFilter("all");
  });
</script>
