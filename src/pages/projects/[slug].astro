---
import { getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { LEGACY_BY_SLUG, getLegacyItem } from "../../data/legacyPortfolio";
import wpProjectContent from "../../data/wpProjectContent.json";

const WP_WORK_BASE = "https://matteocurcio.com/work";

type WpContentMap = Record<string, { paragraphs?: string[]; embedUrl?: string; images?: string[] }>;
const wpContent = wpProjectContent as WpContentMap;

function cleanExcerpt(input?: string) {
  if (!input) return "";
  if (input.includes("(function") || input.includes("$(document")) return "";
  return input
    .replace(/&nbsp;/g, " ")
    .replace(/&amp;/g, "&")
    .replace(/&#8217;/g, "'")
    .replace(/&#038;/g, "&")
    .replace(/<[^>]+>/g, "")
    .replace(/\s+/g, " ")
    .trim();
}

function isEmbedUrl(url?: string) {
  if (!url) return false;
  return /youtube\.com|youtu\.be|vimeo\.com/i.test(url);
}

export async function getStaticPaths() {
  const projects = await getCollection("projects");
  const slugs = new Set<string>(projects.map((project) => project.slug));
  Object.keys(LEGACY_BY_SLUG).forEach((slug) => slugs.add(slug));

  return Array.from(slugs).map((slug) => ({ params: { slug } }));
}

const slug = Astro.params.slug ?? "";
const projects = await getCollection("projects");
const project = projects.find((entry) => entry.slug === slug);
const legacy = getLegacyItem(slug);
const migrated = wpContent[slug] || {};

const title = legacy?.title || project?.data.title || slug;
const service = project?.data.service || "work";
const client = project?.data.client || "Selected Work";
const year = project?.data.year;
const cover = legacy?.image || project?.data.cover;
const coverAlt = project?.data.coverAlt || title;
const previewVideo =
  legacy?.video ||
  project?.data.previewVideo ||
  (project?.data.videoUrl && /\.(mp4|mov)(\?|#|$)/i.test(project.data.videoUrl) ? project.data.videoUrl : undefined);
const originalUrl = project?.data.originalUrl || `${WP_WORK_BASE}/${slug}`;
const excerpt = cleanExcerpt(project?.data.excerpt);

const embeddedUrl = migrated.embedUrl || previewVideo;

const descriptionParagraphs =
  (migrated.paragraphs || []).length > 0
    ? (migrated.paragraphs || [])
    : excerpt
      ? [excerpt]
      : [];

const galleryImages = (migrated.images || []).filter((src) => src && src !== cover).slice(0, 12);

const pageTitle = `${title} | Matteo Curcio`;
---

<BaseLayout title={pageTitle} path={`/projects/${slug}/`}>
  <article class="project-layout">
    <header>
      <p class="kicker">{service}</p>
      <h1>{title}</h1>
      <p class="meta">{client}{year ? ` Â· ${year}` : ""}</p>
    </header>

    {
      cover && (
        <div class="cover">
          <img src={cover} alt={coverAlt} loading="eager" />
        </div>
      )
    }

    {
      embeddedUrl &&
        (isEmbedUrl(embeddedUrl) ? (
          <div class="cover project-embed">
            <iframe
              src={embeddedUrl}
              title={`${title} video`}
              loading="lazy"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
              allowfullscreen
            />
          </div>
        ) : (
          <div class="cover">
            <video class="project-full-video" src={embeddedUrl} controls playsinline preload="metadata" />
          </div>
        ))
    }

    <div class="project-content">
      {descriptionParagraphs.length > 0 ? (
        descriptionParagraphs.map((paragraph) => <p>{paragraph}</p>)
      ) : (
        <p>
          Case study snapshot migrated for parity. Full production notes, credits, and legacy formatting are available
          on the original project page.
        </p>
      )}
      <p>
        <a href={originalUrl} target="_blank" rel="noreferrer">View original case study</a>
      </p>
    </div>

    {
      galleryImages.length > 0 && (
        <section class="project-gallery" aria-label="Project stills">
          {galleryImages.map((src) => (
            <img src={src} alt={title} loading="lazy" />
          ))}
        </section>
      )
    }
  </article>
</BaseLayout>
