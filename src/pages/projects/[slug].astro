---
import { getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { LEGACY_BY_SLUG, LEGACY_REELS, getLegacyItem } from "../../data/legacyPortfolio";
import wpProjectContent from "../../data/wpProjectContent.json";

const WP_WORK_BASE = "https://matteocurcio.com/work";

type WpContentMap = Record<string, { paragraphs?: string[]; embedUrl?: string; images?: string[] }>;
const wpContent = wpProjectContent as WpContentMap;
const LEGACY_REEL_SLUGS = new Set(LEGACY_REELS.map((item) => item.slug));

const CREDIT_LABELS = new Set([
  "production",
  "producers",
  "producer",
  "co-producers",
  "co producers",
  "director",
  "directors",
  "dop",
  "camera",
  "hairs",
  "hair",
  "makeup",
  "editors",
  "editor",
  "colorist",
  "colourist",
  "color",
  "vfx",
  "agency",
  "agency producer",
  "client",
  "campaign",
  "project",
  "cinematographer",
  "cinematography",
  "writer",
  "line producer",
  "executive producer",
  "creative director",
  "interactive",
  "post supervisor",
  "assistant director",
  "art director",
  "assistant art",
  "lighting asst",
  "sound",
  "animation",
  "titles",
  "music",
  "featuring",
  "production design",
  "5.1 sound mix",
  "sound mix",
  "finishing"
]);

const CREDIT_COMPOUND_LABELS: Record<string, string[]> = {
  "director & writer": ["Director", "Writer"],
  "color & finishing": ["Color", "Finishing"],
  "color and finishing": ["Color", "Finishing"],
  "color, vfx": ["Color", "VFX"],
  "vfx, color": ["VFX", "Color"]
};

const CREDIT_CANONICAL: Record<string, string> = {
  "co-producers": "Co-producers",
  "co producers": "Co-producers",
  "dop": "DOP",
  "vfx": "VFX",
  "5.1 sound mix": "5.1 Sound Mix",
  "lighting asst": "Lighting Asst.",
  "creative director": "Creative Director",
  "post supervisor": "Post Supervisor",
  "line producer": "Line Producer",
  "executive producer": "Executive Producer",
  "assistant director": "Assistant Director",
  "art director": "Art Director",
  "assistant art": "Assistant Art",
  "agency producer": "Agency Producer",
  "production design": "Production Design"
};

function cleanExcerpt(input?: string) {
  if (!input) return "";
  if (input.includes("(function") || input.includes("$(document")) return "";
  return input
    .replace(/&nbsp;/g, " ")
    .replace(/&amp;/g, "&")
    .replace(/&#8217;/g, "'")
    .replace(/&#038;/g, "&")
    .replace(/<[^>]+>/g, "")
    .replace(/\s+/g, " ")
    .trim();
}

function isEmbedUrl(url?: string) {
  if (!url) return false;
  return /youtube\.com|youtu\.be|vimeo\.com/i.test(url);
}

function normalizeCreditLabel(input: string) {
  return input
    .toLowerCase()
    .replace(/[“”"']/g, "")
    .replace(/\s+/g, " ")
    .replace(/[.:]/g, "")
    .trim();
}

function formatCreditLabel(label: string) {
  const normalized = normalizeCreditLabel(label);
  if (CREDIT_CANONICAL[normalized]) return CREDIT_CANONICAL[normalized];
  return normalized
    .split(" ")
    .map((part) => (part ? part[0].toUpperCase() + part.slice(1) : part))
    .join(" ");
}

function extractCreditLabels(line: string) {
  const normalized = normalizeCreditLabel(line);
  if (!normalized) return [];

  if (CREDIT_COMPOUND_LABELS[normalized]) {
    return CREDIT_COMPOUND_LABELS[normalized];
  }

  if (CREDIT_LABELS.has(normalized)) {
    return [formatCreditLabel(normalized)];
  }

  const splitParts = normalized
    .split(/,|\s+&\s+|\s+and\s+|\s*\/\s*|\s*\+\s*/)
    .map((part) => part.trim())
    .filter(Boolean);

  if (splitParts.length > 1 && splitParts.every((part) => CREDIT_LABELS.has(part))) {
    return splitParts.map((part) => formatCreditLabel(part));
  }

  return [];
}

function splitDescriptionAndCredits(paragraphs: string[]) {
  const intro: string[] = [];
  const credits = new Map<string, string[]>();
  const creditOrder: string[] = [];

  const pushCredit = (label: string, value: string) => {
    const clean = value.replace(/^[-•\s]+/, "").trim();
    if (!clean) return;
    if (!credits.has(label)) {
      credits.set(label, []);
      creditOrder.push(label);
    }
    credits.get(label)?.push(clean);
  };

  for (const paragraph of paragraphs) {
    const lines = paragraph
      .split("\n")
      .map((line) => line.trim())
      .filter(Boolean);

    if (lines.length === 0) continue;

    let currentLabels: string[] = [];
    let sawCreditLabel = false;
    const paragraphIntro: string[] = [];

    for (const line of lines) {
      const labels = extractCreditLabels(line);
      if (labels.length > 0) {
        currentLabels = labels;
        sawCreditLabel = true;
        for (const label of currentLabels) {
          if (!credits.has(label)) {
            credits.set(label, []);
            creditOrder.push(label);
          }
        }
        continue;
      }

      if (currentLabels.length > 0) {
        for (const label of currentLabels) {
          pushCredit(label, line);
        }
      } else {
        paragraphIntro.push(line);
      }
    }

    if (paragraphIntro.length > 0) {
      intro.push(paragraphIntro.join(" "));
    } else if (!sawCreditLabel) {
      intro.push(paragraph);
    }
  }

  const creditList = creditOrder.map((label) => ({
    label,
    values: Array.from(new Set((credits.get(label) || []).filter(Boolean)))
  }));

  return {
    intro: intro.filter(Boolean),
    credits: creditList.filter((item) => item.values.length > 0)
  };
}

function buildBeforeAfterPairs(images: string[], fallbackImage?: string) {
  const befores = new Map<string, string>();
  const afters = new Map<string, string>();
  const extras: string[] = [];

  const keyFor = (src: string) =>
    src
      .replace(/flat|before|raw|log|grade|after|final|look/gi, "")
      .replace(/[-_]+/g, "-")
      .toLowerCase();

  for (const src of images) {
    if (/flat|before|raw|log/i.test(src)) {
      befores.set(keyFor(src), src);
      continue;
    }

    if (/grade|after|final|look/i.test(src)) {
      afters.set(keyFor(src), src);
      continue;
    }

    extras.push(src);
  }

  const pairs: Array<{ before: string; after: string }> = [];

  for (const [key, before] of befores.entries()) {
    const after = afters.get(key);
    if (after) {
      pairs.push({ before, after });
      afters.delete(key);
    } else {
      extras.push(before);
    }
  }

  for (const [, leftoverAfter] of afters.entries()) {
    extras.push(leftoverAfter);
  }

  if (pairs.length === 0 && images.length >= 2) {
    for (let i = 0; i + 1 < images.length; i += 2) {
      pairs.push({ before: images[i], after: images[i + 1] });
    }
  }

  if (pairs.length === 0 && fallbackImage) {
    pairs.push({ before: fallbackImage, after: fallbackImage });
  }

  return { pairs, extras };
}

export async function getStaticPaths() {
  const projects = await getCollection("projects");
  const slugs = new Set<string>(projects.map((project) => project.slug));
  Object.keys(LEGACY_BY_SLUG).forEach((slug) => slugs.add(slug));

  return Array.from(slugs).map((slug) => ({ params: { slug } }));
}

const slug = Astro.params.slug ?? "";
const projects = await getCollection("projects");
const project = projects.find((entry) => entry.slug === slug);
const legacy = getLegacyItem(slug);
const migrated = wpContent[slug] || {};

const title = legacy?.title || project?.data.title || slug;
const service = LEGACY_REEL_SLUGS.has(slug) ? "REELS" : "COLOUR";
const client = project?.data.client || "Selected Work";
const year = project?.data.year;
const cover = legacy?.image || project?.data.cover;
const coverAlt = project?.data.coverAlt || title;
const previewVideo =
  legacy?.video ||
  project?.data.previewVideo ||
  (project?.data.videoUrl && /\.(mp4|mov)(\?|#|$)/i.test(project.data.videoUrl) ? project.data.videoUrl : undefined);
const originalUrl = project?.data.originalUrl || `${WP_WORK_BASE}/${slug}`;
const excerpt = cleanExcerpt(project?.data.excerpt);

const embeddedUrl = isEmbedUrl(migrated.embedUrl) ? migrated.embedUrl : undefined;
const videoUrl = embeddedUrl ? undefined : previewVideo;

const descriptionParagraphs =
  (migrated.paragraphs || []).length > 0
    ? (migrated.paragraphs || [])
    : excerpt
      ? [excerpt]
      : [];

const parsed = splitDescriptionAndCredits(descriptionParagraphs);
const galleryImages = (migrated.images || []).filter((src) => src && src !== cover).slice(0, 16);
const gallery = buildBeforeAfterPairs(galleryImages, service === "COLOUR" ? cover : undefined);

const pageTitle = `${title} | Matteo Curcio`;
---

<BaseLayout title={pageTitle} path={`/projects/${slug}/`}>
  <article class="project-layout">
    <header>
      <p class="kicker">{service}</p>
      <h1>{title}</h1>
      <p class="meta">{client}{year ? ` · ${year}` : ""}</p>
    </header>

    {
      embeddedUrl ? (
        <div class="cover project-embed">
          <iframe
            src={embeddedUrl}
            title={`${title} video`}
            loading="lazy"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            allowfullscreen
          />
        </div>
      ) : videoUrl ? (
        <div class="cover">
          <video class="project-full-video" src={videoUrl} controls playsinline preload="metadata" />
        </div>
      ) : cover ? (
        <div class="cover">
          <img src={cover} alt={coverAlt} loading="eager" />
        </div>
      ) : null
    }
    <section class={`project-details ${parsed.credits.length === 0 ? "single" : ""}`}>
      <div class="project-description">
        {parsed.intro.length > 0 ? (
          parsed.intro.map((paragraph) => <p>{paragraph}</p>)
        ) : (
          <p>
            Case study snapshot migrated for parity. Full production notes, credits, and legacy formatting are
            available on the original project page.
          </p>
        )}
      </div>

      {
        parsed.credits.length > 0 && (
          <aside class="project-credits" aria-label="Project credits">
            <section class="credits-grid">
              {parsed.credits.map((item) => (
                <div class="credit-item">
                  <p class="credit-label">{item.label}</p>
                  <div class="credit-values-lines">
                    {item.values.map((value) => <p class="credit-value-line">{value}</p>)}
                  </div>
                </div>
              ))}
            </section>
          </aside>
        )
      }
    </section>

    {
      gallery.pairs.length > 0 && (
        <section class="before-after-grid" aria-label="Before and after grade comparisons">
          {gallery.pairs.map((pair, idx) => (
            <figure class="ba-slider" style="--ba-pos:50%">
              <img class="ba-after" src={pair.after} alt={`${title} after`} loading="lazy" />
              <div class="ba-before-wrap">
                <img class="ba-before" src={pair.before} alt={`${title} before`} loading="lazy" />
              </div>
              <div class="ba-handle" aria-hidden="true"></div>
              <input
                class="ba-range"
                type="range"
                min="0"
                max="100"
                value="50"
                aria-label={`Before and after comparison ${idx + 1}`}
              />
              <span class="ba-tag ba-tag-before">Before</span>
              <span class="ba-tag ba-tag-after">After</span>
            </figure>
          ))}
        </section>
      )
    }

    {
      gallery.extras.length > 0 && (
        <section class="project-gallery" aria-label="Project stills">
          {gallery.extras.map((src) => (
            <img src={src} alt={title} loading="lazy" />
          ))}
        </section>
      )
    }
  </article>
<script is:inline>
  const sliders = document.querySelectorAll(".ba-slider");
  sliders.forEach((slider) => {
    const range = slider.querySelector(".ba-range");
    if (!range) return;

    const setPos = (value) => {
      const safe = Math.max(0, Math.min(100, value));
      slider.style.setProperty("--ba-pos", `${safe}%`);
      range.value = String(Math.round(safe));
    };

    const setFromClientX = (clientX) => {
      const rect = slider.getBoundingClientRect();
      if (rect.width === 0) return;
      const value = ((clientX - rect.left) / rect.width) * 100;
      setPos(value);
    };

    range.addEventListener("input", () => setPos(Number(range.value)));

    let dragging = false;

    slider.addEventListener("pointerdown", (event) => {
      dragging = true;
      setFromClientX(event.clientX);
      if (slider.setPointerCapture) {
        slider.setPointerCapture(event.pointerId);
      }
    });

    slider.addEventListener("pointermove", (event) => {
      if (!dragging) return;
      setFromClientX(event.clientX);
    });

    const stop = () => {
      dragging = false;
    };

    slider.addEventListener("pointerup", stop);
    slider.addEventListener("pointercancel", stop);
    slider.addEventListener("pointerleave", stop);

    setPos(Number(range.value));
  });

  const details = document.querySelector(".project-details");
  const description = details?.querySelector(".project-description");
  const credits = details?.querySelector(".project-credits");

  if (details && description && credits && !details.classList.contains("single")) {
    const getWordCount = () =>
      (description.textContent || "")
        .trim()
        .split(/\s+/)
        .filter(Boolean).length;

    const fitDescription = () => {
      description.style.removeProperty("--desc-font-size");
      description.style.removeProperty("--desc-line-height");
      description.classList.remove("desc-expanded");

      const words = getWordCount();
      if (words > 70) return;

      const descriptionHeight = description.scrollHeight;
      const creditsHeight = credits.scrollHeight;
      if (!descriptionHeight || creditsHeight <= descriptionHeight + 20) return;

      const ratio = Math.min(1.3, creditsHeight / descriptionHeight);
      const fontSize = Math.min(1.18, Math.max(1.02, Math.pow(ratio, 0.42)));
      const lineHeight = Math.min(2.15, Math.max(1.75, 1.65 * ratio));

      description.style.setProperty("--desc-font-size", `${fontSize}rem`);
      description.style.setProperty("--desc-line-height", String(lineHeight));
      description.classList.add("desc-expanded");
    };

    fitDescription();
    window.addEventListener("resize", () => requestAnimationFrame(fitDescription));
  }
</script>
</BaseLayout>
